<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Staff Portal - The Isle Prelude Realismo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
    <link rel="stylesheet" href="styles.css"/> </head>
<body data-theme="default">

    <div class="toast-container"></div>

    <div class="login-container" id="loginContainer">
        <div class="login-box">
            <div class="login-logo"><i class="fas fa-shield-alt"></i></div>
            <h1 class="login-title">Staff Portal</h1>
            <p style="color:var(--text-light); margin-bottom: 20px;">The Isle Prelude Realismo</p>
            <div class="alert alert-error" id="loginAlert"></div>
            <div class="input-group">
                <label for="username">Usuário (Discord ID)</label>
                <input type="text" id="username" placeholder="Digite seu Discord ID" required>
            </div>
            <div class="input-group">
                <label for="password">Senha</label>
                <input type="password" id="password" placeholder="Digite sua senha" required>
            </div>
            <button class="btn btn-block" id="loginBtn">Entrar</button>
            <p style="margin-top:20px; font-size:0.9rem; color:var(--text-light);">Esqueceu a senha? Contate a Administração.</p>
        </div>
    </div>

    <div class="app-container" id="appContainer">
        
        <header class="header">
            <div class="app-name">
                <i class="fas fa-shield-alt logo"></i>
                Portal Staff
            </div>
            <div class="header-right">
                <span id="welcomeMessage" style="color:var(--text-light); font-weight:500;"></span>
                <button class="btn btn-sm" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Sair</button>
            </div>
        </header>

        <nav class="nav">
            <ul class="nav-list">
                <li class="nav-item active" data-tab="dashboard">
                    <button class="nav-button" data-text="&nbsp;Dashboard&nbsp;">
                        <span class="actual-text">&nbsp;Dashboard&nbsp;</span>
                        <span aria-hidden="true" class="hover-text">&nbsp;Dashboard&nbsp;</span>
                    </button>
                </li>
                <li class="nav-item" data-tab="denuncias">
                    <button class="nav-button" data-text="&nbsp;Quadro de Denúncias&nbsp;">
                        <span class="actual-text">&nbsp;Quadro de Denúncias&nbsp;</span>
                        <span aria-hidden="true" class="hover-text">&nbsp;Quadro de Denúncias&nbsp;</span>
                    </button>
                </li>
                <li class="nav-item" data-tab="fichas">
                    <button class="nav-button" data-text="&nbsp;Fichas de Players&nbsp;">
                        <span class="actual-text">&nbsp;Fichas de Players&nbsp;</span>
                        <span aria-hidden="true" class="hover-text">&nbsp;Fichas de Players&nbsp;</span>
                    </button>
                </li>
                <li class="nav-item" data-tab="agenda">
                    <button class="nav-button" data-text="&nbsp;Agenda&nbsp;">
                        <span class="actual-text">&nbsp;Agenda&nbsp;</span>
                        <span aria-hidden="true" class="hover-text">&nbsp;Agenda&nbsp;</span>
                    </button>
                </li>
                <li class="nav-item" data-tab="historico">
                    <button class="nav-button" data-text="&nbsp;Histórico&nbsp;">
                        <span class="actual-text">&nbsp;Histórico&nbsp;</span>
                        <span aria-hidden="true" class="hover-text">&nbsp;Histórico&nbsp;</span>
                    </button>
                </li>
                <li class="nav-item" data-tab="config">
                    <button class="nav-button" data-text="&nbsp;Configurações&nbsp;">
                        <span class="actual-text">&nbsp;Configurações&nbsp;</span>
                        <span aria-hidden="true" class="hover-text">&nbsp;Configurações&nbsp;</span>
                    </button>
                </li>
                <li class="nav-item" data-tab="anotacoes">
                    <button class="nav-button" data-text="&nbsp;Anotações Gerais&nbsp;">
                        <span class="actual-text">&nbsp;Anotações Gerais&nbsp;</span>
                        <span aria-hidden="true" class="hover-text">&nbsp;Anotações Gerais&nbsp;</span>
                    </button>
                </li>
            </ul>
        </nav>
        <main class="main-content">
            
            <section class="tab-content active" id="dashboard">
                <h2 style="margin-bottom: 20px;">Visão Geral do Staff</h2>
                
                <div class="dashboard-grid">
                    <div class="card">
                        <div class="card-title">Estatísticas Rápidas</div>
                        <div class="stat-grid">
                            <div class="stat-item">
                                <div class="stat-value" id="totalDenuncias">0</div>
                                <div class="stat-label">Denúncias Abertas</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="denunciasNaoAtribuidas">0</div>
                                <div class="stat-label">Não Atribuídas</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="seusCasosAbertos">0</div>
                                <div class="stat-label">Seus Casos Abertos</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="fichasRegistradas">0</div>
                                <div class="stat-label">Fichas de Players</div>
                            </div>
                        </div>
                        <div class="quick-actions">
                            <button class="action-btn" onclick="openModal('newDenunciaModal')">
                                <i class="fas fa-plus-circle action-icon"></i>
                                <span class="action-text">Nova Denúncia</span>
                            </button>
                            <button class="action-btn" onclick="openModal('newFichaModal')">
                                <i class="fas fa-user-plus action-icon"></i>
                                <span class="action-text">Nova Ficha</span>
                            </button>
                            <button class="action-btn" onclick="openModal('newAppointmentModal')">
                                <i class="fas fa-calendar-plus action-icon"></i>
                                <span class="action-text">Novo Evento</span>
                            </button>
                            <button class="action-btn" onclick="changeTab('historico')">
                                <i class="fas fa-clock action-icon"></i>
                                <span class="action-text">Ver Histórico</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-title">Próximos Compromissos <i class="fas fa-calendar-alt"></i></div>
                        <div id="upcomingAppointmentsList">
                            <p style="color:var(--text-light);">Nenhum compromisso agendado.</p>
                        </div>
                        <button class="btn btn-sm" style="margin-top: 15px;" onclick="changeTab('agenda')">Ver Agenda Completa</button>
                    </div>

                    <div class="card">
                        <div class="card-title">Anotações Rápidas <i class="fas fa-paperclip"></i></div>
                        <div class="form-group">
                            <textarea id="anotacoesRapidas" placeholder="Suas anotações pessoais rápidas..." oninput="saveAnotacoesRapidas()"></textarea>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-title">Últimas Ações <i class="fas fa-history"></i></div>
                        <div class="history-list" id="dashboardHistory">
                            <p style="color:var(--text-light);">Nenhuma ação recente.</p>
                        </div>
                    </div>
                </div>
            </section>

            <section class="tab-content" id="denuncias">
                <div class="board-header">
                    <h2>Quadro de Denúncias</h2>
                    <div class="board-actions">
                        <button class="btn" onclick="openModal('newDenunciaModal')"><i class="fas fa-plus"></i> Nova Denúncia</button>
                        <button class="btn btn-sm" onclick="openModal('settingsModal', 'denunciasConfig')"><i class="fas fa-cog"></i> Configurações</button>
                    </div>
                </div>
                <div class="board" id="denunciasBoard">
                    </div>
            </section>
            
            <section class="tab-content" id="fichas">
                <div class="fichas-header">
                    <h2>Registro de Fichas de Players</h2>
                    <div class="board-actions">
                        <button class="btn" onclick="openModal('newFichaModal')"><i class="fas fa-plus"></i> Nova Ficha</button>
                        <input type="text" id="fichaSearch" placeholder="Buscar por Nome ou ID..." onkeyup="filterFichas()" style="padding: 10px; border-radius: 6px; border: 1px solid var(--border); background-color: var(--card-bg); color: var(--text);">
                    </div>
                </div>
                <div class="players-grid" id="fichasGrid">
                    <p style="color:var(--text-light);">Nenhuma ficha registrada.</p>
                </div>
            </section>

            <section class="tab-content" id="agenda">
                <h2>Agenda e Eventos</h2>
                <div class="card" style="margin-top: 20px;">
                    <div class="calendar-header">
                        <button onclick="changeMonth(-1)"><i class="fas fa-chevron-left"></i></button>
                        <h3 id="currentMonthYear">Mês Ano</h3>
                        <button onclick="changeMonth(1)"><i class="fas fa-chevron-right"></i></button>
                    </div>
                    <div class="calendar-grid" id="calendarGrid">
                        </div>
                    <div style="text-align: right; margin-top: 20px;">
                        <button class="btn" onclick="openModal('newAppointmentModal')"><i class="fas fa-plus"></i> Novo Evento</button>
                    </div>
                </div>
            </section>

            <section class="tab-content" id="historico">
                <h2>Histórico de Ações</h2>
                <div class="card" style="margin-top: 20px;">
                    <div class="history-list" id="fullHistoricoList">
                        <p style="color:var(--text-light);">Carregando histórico completo...</p>
                    </div>
                </div>
            </section>

            <section class="tab-content" id="config">
                <h2>Configurações do Portal</h2>
                <div class="card" style="margin-top: 20px;">
                    <div class="card-title">Aparência</div>
                    
                    <div class="form-group">
                        <label for="themeSelector">Tema Visual</label>
                        <div class="custom-select-container">
                            <select id="themeSelector">
                                <option value="default">Padrão (Azul Claro)</option>
                                <option value="dark">Escuro (High Contrast)</option>
                                <option value="green">Verde</option>
                                <option value="red-black">Vermelho e Preto (Dark)</option>
                                <option value="neon-azul">Neon Azul (Dark)</option>
                                <option value="dourado-preto">Dourado e Preto (Dark)</option>
                                <option value="roxo-neon">Roxo Neon (Dark)</option>
                                <option value="roxo">Roxo (Light)</option>
                                <option value="amarelo">Amarelo (Light)</option>
                                <option value="verde-agua">Verde Água (Light)</option>
                                <option value="preto-branco">Preto e Branco (Dark)</option>
                                <option value="custom">Personalizado...</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="customThemeContainer">
                        <p style="margin-bottom: 15px; font-weight: 500;">Cores Personalizadas</p>
                        <div class="color-picker-group">
                            <div class="color-picker-item">
                                <label for="customPrimary">Cor Primária</label>
                                <input type="color" id="customPrimary" value="#1a73e8" onchange="applyCustomTheme()">
                            </div>
                            <div class="color-picker-item">
                                <label for="customBg">Cor de Fundo</label>
                                <input type="color" id="customBg" value="#f8f9fa" onchange="applyCustomTheme()">
                            </div>
                            <div class="color-picker-item">
                                <label for="customCardBg">Cor de Cards</label>
                                <input type="color" id="customCardBg" value="#ffffff" onchange="applyCustomTheme()">
                            </div>
                            <div class="color-picker-item">
                                <label for="customText">Cor do Texto</label>
                                <input type="color" id="customText" value="#202124" onchange="applyCustomTheme()">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 20px;">
                    <div class="card-title">Configurações de Dados</div>
                    <div class="toggle-switch-container">
                        <label class="toggle-switch-label">Sincronização Automática de Dados (Global)</label>
                        <label class="switch">
                            <input type="checkbox" id="autoSyncToggle">
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div class="backup-section">
                        <button class="btn btn-sm" onclick="exportData()"><i class="fas fa-download"></i> Exportar Todos os Dados</button>
                        <button class="btn btn-sm" onclick="document.getElementById('importFile').click()"><i class="fas fa-upload"></i> Importar Dados (JSON)</button>
                        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
                    </div>
                </div>
            </section>

            <section class="tab-content" id="anotacoes">
                <h2>Anotações Gerais (Visíveis a Todos)</h2>
                <div class="card" style="margin-top: 20px;">
                    <div class="form-group">
                        <textarea id="anotacoesGerais" placeholder="Anotações importantes e guias de referência para toda a equipe..." oninput="saveAnotacoesGerais()"></textarea>
                    </div>
                </div>
            </section>

        </main>
        
    </div>

    <div class="modal" id="newAppointmentModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title" id="appointmentModalTitle">Novo Evento</h3>
                <button class="modal-close" onclick="closeModal('newAppointmentModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="appointmentId">
                <div class="form-group">
                    <label for="appointmentTitle">Título do Evento</label>
                    <input type="text" id="appointmentTitle" placeholder="Reunião Semanal, Caçada RP, etc." required>
                </div>
                <div class="form-group">
                    <label for="appointmentDate">Data</label>
                    <input type="date" id="appointmentDate" required>
                </div>
                <div class="form-group">
                    <label for="appointmentTime">Hora (Opcional)</label>
                    <input type="time" id="appointmentTime">
                </div>
                <div class="form-group">
                    <label for="appointmentDesc">Descrição (Opcional)</label>
                    <textarea id="appointmentDesc" placeholder="Detalhes do evento..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="saveAppointment()" id="saveAppointmentBtn">Salvar Evento</button>
            </div>
        </div>
    </div>

    <div class="modal" id="newDenunciaModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Registrar Nova Denúncia</h3>
                <button class="modal-close" onclick="closeModal('newDenunciaModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="denunciaId">
                <div class="form-group">
                    <label for="denunciaTitulo">Título/Assunto</label>
                    <input type="text" id="denunciaTitulo" placeholder="Ex: Quebra de Regra de Caçada" required>
                </div>
                <div class="form-group">
                    <label for="denunciaPlayer">Player Denunciado (ID/Nome)</label>
                    <input type="text" id="denunciaPlayer" placeholder="ID do Discord ou Nome do Player" required>
                </div>
                <div class="form-group">
                    <label for="denunciaDesc">Descrição Detalhada</label>
                    <textarea id="denunciaDesc" placeholder="Detalhes do ocorrido, data, hora, contexto..."></textarea>
                </div>
                
                <div class="form-group">
                    <label>Tópico / Status</label>
                    <div class="custom-select-container">
                        <select id="denunciaTopicoSelect"></select>
                    </div>
                </div>

                <div class="form-group">
                    <label>Anexos (Imagens/Vídeos)</label>
                    <div class="file-upload" onclick="document.getElementById('denunciaFiles').click()">
                        <i class="fas fa-upload"></i>
                        <p>Clique para enviar arquivos ou arraste-os aqui.</p>
                    </div>
                    <input type="file" id="denunciaFiles" multiple accept="image/*,video/*,.pdf" style="display: none;">
                    <div class="anexos-preview" id="denunciaAnexosPreview">
                        </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="saveDenuncia()" id="saveDenunciaBtn">Salvar Denúncia</button>
            </div>
        </div>
    </div>

    <div class="modal" id="denunciaDetailsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="denunciaDetailsTitle">Detalhes da Denúncia</h3>
                <button class="modal-close" onclick="closeModal('denunciaDetailsModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="denuncia-details">
                    <div class="detail-item">
                        <div class="detail-label">ID da Denúncia</div>
                        <div class="detail-value" id="denunciaDetailsId"></div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Player Denunciado</div>
                        <div class="detail-value" id="denunciaDetailsPlayer"></div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Tópico</div>
                        <div class="detail-value" id="denunciaDetailsTopico"></div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Status</div>
                        <div class="detail-value" id="denunciaDetailsStatus"></div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Atribuído a</div>
                        <div class="detail-value" id="denunciaDetailsAssignee"></div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Descrição</div>
                        <div class="detail-value" id="denunciaDetailsDesc" style="white-space: pre-wrap;"></div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Anexos</div>
                        <div class="anexos-preview" id="denunciaDetailsAnexos"></div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Criação</div>
                        <div class="detail-value" id="denunciaDetailsCreated"></div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Última Atualização</div>
                        <div class="detail-value" id="denunciaDetailsUpdated"></div>
                    </div>
                    
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-sm" style="background-color: var(--danger);" onclick="deleteDenuncia()"><i class="fas fa-trash"></i> Excluir</button>
                <button class="btn" onclick="editDenunciaDetails()"><i class="fas fa-edit"></i> Editar</button>
            </div>
        </div>
    </div>

    <div class="modal" id="newFichaModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title" id="fichaModalTitle">Registrar Nova Ficha</h3>
                <button class="modal-close" onclick="closeModal('newFichaModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="fichaId">
                <div class="form-group">
                    <label for="fichaPlayerName">Nome do Player</label>
                    <input type="text" id="fichaPlayerName" placeholder="Nome do Player" required>
                </div>
                <div class="form-group">
                    <label for="fichaPlayerId">Discord ID</label>
                    <input type="text" id="fichaPlayerId" placeholder="ID do Discord" required>
                </div>
                <div class="form-group">
                    <label for="fichaBehavior">Comportamento (Resumo)</label>
                    <textarea id="fichaBehavior" placeholder="Resumo do histórico de comportamento do player."></textarea>
                </div>
                <div class="form-group">
                    <label for="fichaAdvertencias">Advertências</label>
                    <input type="number" id="fichaAdvertencias" min="0" value="0">
                </div>
                <div class="form-group">
                    <label for="fichaBans">Bans</label>
                    <input type="number" id="fichaBans" min="0" value="0">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="saveFicha()" id="saveFichaBtn">Salvar Ficha</button>
            </div>
        </div>
    </div>

    <div class="modal" id="fichaDetailsModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title" id="fichaDetailsName">Detalhes da Ficha</h3>
                <button class="modal-close" onclick="closeModal('fichaDetailsModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="player-card" style="box-shadow: none;">
                    <span class="player-id" id="fichaDetailsId"></span>
                    <h4 class="player-name" id="fichaDetailsPlayerName"></h4>
                    <p class="player-behavior" id="fichaDetailsBehavior"></p>
                    <div class="player-stats">
                        <div class="stat-badge">
                            <div class="stat-badge-value" id="fichaDetailsAdvertencias"></div>
                            <div class="stat-badge-label">Advertências</div>
                        </div>
                        <div class="stat-badge">
                            <div class="stat-badge-value" id="fichaDetailsBans"></div>
                            <div class="stat-badge-label">Bans</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-sm" style="background-color: var(--danger);" onclick="deleteFicha()"><i class="fas fa-trash"></i> Excluir</button>
                <button class="btn" onclick="editFichaDetails()"><i class="fas fa-edit"></i> Editar</button>
            </div>
        </div>
    </div>

    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Configurações</h3>
                <button class="modal-close" onclick="closeModal('settingsModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="denunciasConfig" class="config-tab-content">
                    <h4>Tópicos do Quadro de Denúncias</h4>
                    <p style="color:var(--text-light); margin-bottom: 15px;">Defina os tópicos (colunas) e a cor de destaque para cada um.</p>
                    <div class="form-group">
                        <label for="newTopicoName">Novo Tópico</label>
                        <input type="text" id="newTopicoName" placeholder="Nome do Tópico (Ex: Em Análise)">
                    </div>
                    <div class="form-group">
                        <label for="newTopicoColor">Cor de Destaque</label>
                        <input type="color" id="newTopicoColor" value="#1a73e8">
                    </div>
                    <button class="btn btn-sm" onclick="addTopico()"><i class="fas fa-plus"></i> Adicionar Tópico</button>
                    
                    <h5 style="margin-top: 20px;">Tópicos Atuais:</h5>
                    <ul id="topicosList" style="list-style: none; padding: 0; margin-top: 10px;">
                        </ul>

                    <h4 style="margin-top: 30px;">Fundo Personalizado (Quadro de Denúncias)</h4>
                    <p style="color:var(--text-light); margin-bottom: 15px;">URL de uma imagem para o fundo do quadro.</p>
                    <div class="form-group">
                        <label for="denunciasBgUrl">URL da Imagem</label>
                        <input type="text" id="denunciasBgUrl" placeholder="Ex: https://example.com/image.jpg" oninput="saveDenunciasBg()">
                    </div>
                    <button class="btn btn-sm" onclick="clearDenunciasBg()" style="background-color: var(--danger);"><i class="fas fa-times"></i> Remover Fundo</button>

                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('settingsModal')">Fechar</button>
            </div>
        </div>
    </div>

    <div class="modal" id="moveDenunciaModal">
      <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
          <h3 class="modal-title">Mover Denúncia</h3>
          <button class="modal-close" onclick="document.getElementById('moveDenunciaModal').style.display='none'">&times;</button>
        </div>
        <div class="modal-body">
          <p>Selecione o novo tópico:</p>
          <div class="custom-select-container">
            <select id="moveTopicoSelect"></select>
          </div>
          </div>
        <div class="modal-footer">
            <button class="btn" onclick="confirmMoveDenuncia()" id="confirmMoveBtn">Mover</button>
        </div>
      </div>
    </div>

    <script>
        const navItems = document.querySelectorAll('.nav-item');
        const tabContents = document.querySelectorAll('.tab-content');
        const loginContainer = document.getElementById('loginContainer');
        const appContainer = document.getElementById('appContainer');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const loginAlert = document.getElementById('loginAlert');
        const welcomeMessage = document.getElementById('welcomeMessage');
        const themeSelector = document.getElementById('themeSelector');
        const customThemeContainer = document.getElementById('customThemeContainer');
        const autoSyncToggle = document.getElementById('autoSyncToggle');

        let currentUser = null;
        let data = {}; // Objeto global para armazenar todos os dados
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let currentDenunciaIdToMove = null;

        const USERS = {
            "staff1": "staff1", // ID: "staff1", Senha: "staff1"
            "staff2": "staff2",
            "admin": "admin"
        };
        const ADMIN_ROLES = ["admin"];

        // Função para mostrar toast de notificação
        function showToast(message, type = 'info') {
            const container = document.querySelector('.toast-container');
            const toast = document.createElement('div');
            toast.classList.add('toast', type);
            toast.innerHTML = `<i class="fas ${getIcon(type)}"></i> ${message}`;
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = 0;
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }

        function getIcon(type) {
            switch(type) {
                case 'success': return 'fa-check-circle';
                case 'error': return 'fa-exclamation-circle';
                case 'warning': return 'fa-exclamation-triangle';
                default: return 'fa-info-circle';
            }
        }
        
        // =========================
        // Funções de Login/Autenticação
        // =========================
        
        function checkAuth() {
            const savedUser = localStorage.getItem('currentUser');
            const savedData = localStorage.getItem('appData');
            
            if (savedUser && USERS[savedUser]) {
                currentUser = savedUser;
                loadData(savedData);
                showApp();
                initApp();
            } else {
                showLogin();
            }
        }

        function handleLogin() {
            const username = usernameInput.value.trim();
            const password = passwordInput.value;
            
            if (USERS[username] && USERS[username] === password) {
                currentUser = username;
                localStorage.setItem('currentUser', currentUser);
                loadData();
                showApp();
                initApp();
                showToast(`Bem-vindo(a), ${currentUser}!`, 'success');
            } else {
                loginAlert.textContent = 'Usuário ou senha inválidos.';
                loginAlert.style.display = 'block';
            }
        }
        
        function handleLogout() {
            localStorage.removeItem('currentUser');
            currentUser = null;
            showLogin();
            showToast('Sessão encerrada.', 'info');
        }

        function showLogin() {
            loginContainer.style.display = 'flex';
            appContainer.style.display = 'none';
            loginAlert.style.display = 'none';
            usernameInput.value = '';
            passwordInput.value = '';
        }

        function showApp() {
            loginContainer.style.display = 'none';
            appContainer.style.display = 'flex';
            welcomeMessage.textContent = `Logado como: ${currentUser}`;
        }
        
        loginBtn.addEventListener('click', handleLogin);
        logoutBtn.addEventListener('click', handleLogout);

        // =========================
        // Funções de Persistência de Dados
        // =========================
        
        function loadData(savedData) {
            try {
                if (savedData) {
                    data = JSON.parse(savedData);
                } else {
                    const localData = localStorage.getItem('appData');
                    data = localData ? JSON.parse(localData) : getDefaultData();
                }
                
            } catch (e) {
                console.error("Erro ao carregar dados", e);
                data = getDefaultData();
                showToast('Erro ao carregar dados locais. Usando dados padrão.', 'error');
            }
            
            // Garantir que todas as chaves existam
            const defaultData = getDefaultData();
            for (const key in defaultData) {
                if (!data.hasOwnProperty(key)) {
                    data[key] = defaultData[key];
                }
            }
            
            // Garantir que os tópicos tenham cores
            data.denuncias.topicos = data.denuncias.topicos.map(topico => ({
                ...topico,
                color: topico.color || '#1a73e8' // Cor padrão
            }));

            // Carregar configurações de usuário
            loadUserConfig();
            
            // Inicializar o seletor de tema
            initThemeSelector();

            // Carregar estado do toggle de sincronização
            autoSyncToggle.checked = data.settings.autoSync;
            
            // Aplicar o tema
            applyTheme(data.settings.theme);

            // Carregar anotações rápidas
            document.getElementById('anotacoesRapidas').value = data.anotacoes.rapidas[currentUser] || '';
            document.getElementById('anotacoesGerais').value = data.anotacoes.gerais || '';

            // Renderizar quadros
            renderDenunciasBoard();
            renderFichasGrid();
            renderTopicosList(); // Para o modal de configurações
            renderDashboardStats();
            renderDashboardHistory();
            initCalendar(); // Inicializa o calendário com os eventos carregados
            renderUpcomingAppointments();
            
            
        }

        function getDefaultData() {
            return {
                denuncias: {
                    topicos: [
                        { id: 'aberta', name: 'Em Análise', color: '#f4b400' },
                        { id: 'atribuida', name: 'Em Andamento', color: '#4285f4' },
                        { id: 'concluida', name: 'Concluída', color: '#0f9d58' },
                        { id: 'arquivada', name: 'Arquivada/Inválida', color: '#db4437' }
                    ],
                    bgUrl: '',
                    items: []
                },
                fichas: [],
                agenda: [],
                historico: [],
                settings: {
                    theme: 'default',
                    autoSync: true
                },
                userConfigs: {}, // Configurações por usuário
                anotacoes: {
                    rapidas: {}, // Anotações rápidas por usuário
                    gerais: '' // Anotações gerais
                }
            };
        }

        function saveData() {
            if (!data.settings.autoSync) return; // Não salvar se a sincronização estiver desativada

            // Salvar anotações rápidas atuais antes de persistir
            data.anotacoes.rapidas[currentUser] = document.getElementById('anotacoesRapidas').value;
            data.anotacoes.gerais = document.getElementById('anotacoesGerais').value;

            try {
                localStorage.setItem('appData', JSON.stringify(data));
            } catch (e) {
                console.error("Erro ao salvar dados", e);
                showToast('Erro ao salvar dados locais. Espaço esgotado?', 'error');
            }
        }
        
        // Listener para toggle de sincronização
        autoSyncToggle.addEventListener('change', () => {
            data.settings.autoSync = autoSyncToggle.checked;
            saveUserConfig(); // Salva o estado do toggle no settings do usuário
            showToast(`Sincronização ${autoSyncToggle.checked ? 'ativada' : 'desativada'}.`, 'info');
            if (autoSyncToggle.checked) saveData();
        });


        // =========================
        // Funções de Inicialização
        // =========================
        
        function initApp() {
            // Inicializar e carregar todos os componentes necessários
            renderDenunciasBoard();
            renderFichasGrid();
            renderDashboardStats();
            renderDashboardHistory();
            initCalendar();
            renderUpcomingAppointments();
            renderTopicosList();
            initCustomSelect();
        }

        function changeTab(tabName) {
            navItems.forEach(n=>n.classList.remove('active'));
            tabContents.forEach(tc => tc.classList.remove('active'));

            const targetNavItem = document.querySelector(`.nav-item[data-tab="${tabName}"]`);
            const targetTabContent = document.getElementById(tabName);
            
            if (targetNavItem) targetNavItem.classList.add('active');
            if (targetTabContent) targetTabContent.classList.add('active');

            if (tabName === 'historico') initFullHistorico();
            if (tabName === 'agenda') {
                initCalendar(); // Recarrega o calendário ao entrar na aba
                renderUpcomingAppointments();
            }
        }
        
        /* =========================
           Navegação de abas (MODIFICADA)
           ========================= */
        navItems.forEach(item => {
            // Adiciona listener tanto na LI quanto no BUTTON, garantindo que o evento propague e o nav-item seja o alvo
            item.addEventListener('click', (e) => {
                // Encontra o item raiz, mesmo que o clique seja no botão interno
                const targetItem = e.currentTarget;
                
                navItems.forEach(n=>n.classList.remove('active'));
                targetItem.classList.add('active');
                tabContents.forEach(tc => tc.classList.remove('active'));
                document.getElementById(targetItem.dataset.tab).classList.add('active');
                if (targetItem.dataset.tab === 'historico') initFullHistorico();
            });
        });

        // =========================
        // Funções de Utilitários
        // =========================
        
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substring(2);
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }
        
        function formatDateInput(timestamp) {
            const date = new Date(timestamp);
            return date.toISOString().split('T')[0];
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        function openModal(id, configTab = null) {
            const modal = document.getElementById(id);
            modal.style.display = 'flex';
            
            if (id === 'newDenunciaModal' || id === 'denunciaDetailsModal') {
                populateTopicoSelect(document.getElementById('denunciaTopicoSelect'));
                if (id === 'denunciaDetailsModal') {
                    // Preenchimento de detalhes feito em renderDenunciaCard
                } else {
                    // Resetar o formulário para nova denúncia
                    document.getElementById('denunciaId').value = '';
                    document.getElementById('denunciaTitulo').value = '';
                    document.getElementById('denunciaPlayer').value = '';
                    document.getElementById('denunciaDesc').value = '';
                    document.getElementById('denunciaAnexosPreview').innerHTML = '';
                    document.getElementById('saveDenunciaBtn').textContent = 'Salvar Denúncia';
                }
            } else if (id === 'newFichaModal') {
                // Resetar o formulário para nova ficha
                document.getElementById('fichaId').value = '';
                document.getElementById('fichaPlayerName').value = '';
                document.getElementById('fichaPlayerId').value = '';
                document.getElementById('fichaBehavior').value = '';
                document.getElementById('fichaAdvertencias').value = 0;
                document.getElementById('fichaBans').value = 0;
                document.getElementById('saveFichaBtn').textContent = 'Salvar Ficha';
                document.getElementById('fichaModalTitle').textContent = 'Registrar Nova Ficha';
            } else if (id === 'newAppointmentModal') {
                // Resetar o formulário de evento
                document.getElementById('appointmentId').value = '';
                document.getElementById('appointmentTitle').value = '';
                document.getElementById('appointmentDate').value = formatDateInput(Date.now());
                document.getElementById('appointmentTime').value = '';
                document.getElementById('appointmentDesc').value = '';
                document.getElementById('appointmentModalTitle').textContent = 'Novo Evento';
                document.getElementById('saveAppointmentBtn').textContent = 'Salvar Evento';
            } else if (id === 'settingsModal') {
                document.querySelectorAll('.config-tab-content').forEach(el => el.style.display = 'none');
                if (configTab) {
                    document.getElementById(configTab).style.display = 'block';
                }
            }
            
            initCustomSelect();
        }


        // =========================
        // Funções de Temas e Configurações
        // =========================
        
        function applyTheme(themeName) {
            const body = document.body;
            body.setAttribute('data-theme', themeName);
            data.settings.theme = themeName;
            
            // Atualizar cor de destaque do quadro de denúncias
            const topicos = data.denuncias.topicos;
            const topicoDefaultColor = getComputedStyle(body).getPropertyValue('--primary');
            topicos.forEach(topico => {
                topico.color = topico.color || topicoDefaultColor;
            });
            renderDenunciasBoard(); // Recarrega o board para aplicar as cores

            // Atualizar URL de fundo de denúncias
            document.getElementById('denuncias').style.backgroundImage = data.denuncias.bgUrl ? `url(${data.denuncias.bgUrl})` : 'var(--denuncias-bg)';
            document.getElementById('denunciasBgUrl').value = data.denuncias.bgUrl;

            // Salva a config do tema após aplicar
            saveUserConfig();
        }

        function initThemeSelector() {
            themeSelector.value = data.settings.theme;
            if (data.settings.theme === 'custom') {
                customThemeContainer.style.display = 'block';
                document.getElementById('customPrimary').value = data.userConfigs[currentUser]?.customTheme?.primary || '#1a73e8';
                document.getElementById('customBg').value = data.userConfigs[currentUser]?.customTheme?.bg || '#f8f9fa';
                document.getElementById('customCardBg').value = data.userConfigs[currentUser]?.customTheme?.cardBg || '#ffffff';
                document.getElementById('customText').value = data.userConfigs[currentUser]?.customTheme?.text || '#202124';
            } else {
                customThemeContainer.style.display = 'none';
            }
        }

        themeSelector.addEventListener('change', (e) => {
            const selectedTheme = e.target.value;
            if (selectedTheme === 'custom') {
                customThemeContainer.style.display = 'block';
                applyCustomTheme();
            } else {
                customThemeContainer.style.display = 'none';
                applyTheme(selectedTheme);
            }
        });

        function applyCustomTheme() {
            const primary = document.getElementById('customPrimary').value;
            const bg = document.getElementById('customBg').value;
            const cardBg = document.getElementById('customCardBg').value;
            const text = document.getElementById('customText').value;

            document.documentElement.style.setProperty('--primary', primary);
            document.documentElement.style.setProperty('--bg', bg);
            document.documentElement.style.setProperty('--card-bg', cardBg);
            document.documentElement.style.setProperty('--text', text);

            data.settings.theme = 'custom';
            
            if (!data.userConfigs[currentUser]) data.userConfigs[currentUser] = {};
            data.userConfigs[currentUser].customTheme = { primary, bg, cardBg, text };
            
            saveUserConfig();
            renderDenunciasBoard();
            showToast('Tema personalizado aplicado.', 'success');
        }

        function saveUserConfig() {
            if (!data.userConfigs[currentUser]) data.userConfigs[currentUser] = {};
            data.userConfigs[currentUser].theme = data.settings.theme;
            data.userConfigs[currentUser].autoSync = data.settings.autoSync;
            saveData();
        }

        function loadUserConfig() {
            const userConfig = data.userConfigs[currentUser];
            if (userConfig) {
                data.settings.theme = userConfig.theme || 'default';
                data.settings.autoSync = userConfig.autoSync !== undefined ? userConfig.autoSync : true;

                if (data.settings.theme === 'custom' && userConfig.customTheme) {
                    const { primary, bg, cardBg, text } = userConfig.customTheme;
                    document.documentElement.style.setProperty('--primary', primary);
                    document.documentElement.style.setProperty('--bg', bg);
                    document.documentElement.style.setProperty('--card-bg', cardBg);
                    document.documentElement.style.setProperty('--text', text);
                }
            }
        }
        
        // =========================
        // Funções de Anotações
        // =========================

        function saveAnotacoesRapidas() {
            data.anotacoes.rapidas[currentUser] = document.getElementById('anotacoesRapidas').value;
            saveData();
        }

        function saveAnotacoesGerais() {
            data.anotacoes.gerais = document.getElementById('anotacoesGerais').value;
            saveData();
        }


        // =========================
        // Funções de Denúncias (Board)
        // =========================

        function getTopicoById(id) {
            return data.denuncias.topicos.find(t => t.id === id);
        }

        function getTopicoColor(id) {
            const topico = getTopicoById(id);
            return topico ? topico.color : '#ccc';
        }
        
        function renderDenunciasBoard() {
            const board = document.getElementById('denunciasBoard');
            board.innerHTML = '';
            
            // Define o fundo
            document.getElementById('denuncias').style.backgroundImage = data.denuncias.bgUrl ? `url(${data.denuncias.bgUrl})` : 'var(--denuncias-bg)';
            document.getElementById('denunciasBgUrl').value = data.denuncias.bgUrl;

            // Ordenar tópicos para garantir que a ordem de exibição seja consistente
            const sortedTopicos = data.denuncias.topicos;

            sortedTopicos.forEach(topico => {
                const column = document.createElement('div');
                column.classList.add('board-column');
                column.id = `column-${topico.id}`;
                column.setAttribute('data-topico-id', topico.id);
                column.setAttribute('ondragover', 'allowDrop(event)');
                column.setAttribute('ondrop', 'drop(event)');

                const itemsInTopico = data.denuncias.items.filter(item => item.topicoId === topico.id);

                column.innerHTML = `
                    <div class="column-header" style="border-bottom: 3px solid ${topico.color};">
                        <h4 class="column-title" style="color:${topico.color};">${topico.name}</h4>
                        <span class="column-count" style="background-color: ${topico.color};">${itemsInTopico.length}</span>
                    </div>
                    <div class="column-cards" id="cards-${topico.id}">
                        </div>
                `;
                
                const cardContainer = column.querySelector('.column-cards');

                itemsInTopico.sort((a, b) => b.created - a.created).forEach(item => {
                    const card = renderDenunciaCard(item, topico.color);
                    cardContainer.appendChild(card);
                });

                board.appendChild(column);
            });
            
            renderDashboardStats(); // Atualiza estatísticas do dashboard
        }
        
        function renderDenunciaCard(item, topicoColor) {
            const card = document.createElement('div');
            card.classList.add('card-item');
            card.id = `denuncia-${item.id}`;
            card.setAttribute('draggable', 'true');
            card.setAttribute('ondragstart', `drag(event, '${item.id}')`);
            card.setAttribute('onclick', `showDenunciaDetails('${item.id}')`);
            
            const assigneeName = item.assignee ? (item.assignee === currentUser ? 'Eu' : item.assignee) : 'Não Atribuído';
            const assigneeColor = item.assignee ? topicoColor : 'var(--text-light)';

            card.innerHTML = `
                <div class="card-actions">
                    <button class="card-action-btn" onclick="event.stopPropagation(); openMoveModal('${item.id}')" title="Mover"><i class="fas fa-arrows-alt"></i></button>
                    <button class="card-action-btn" onclick="event.stopPropagation(); deleteDenuncia('${item.id}')" title="Excluir"><i class="fas fa-trash"></i></button>
                </div>
                <div class="card-tags">
                    <span class="card-tag" style="background-color: ${topicoColor};">${getTopicoById(item.topicoId).name}</span>
                    <span class="card-tag" style="background-color: ${assigneeColor}; font-size: 0.7rem;">${assigneeName}</span>
                </div>
                <div class="card-content">
                    <h5 class="card-title">${item.title}</h5>
                    <p class="card-desc">${item.description}</p>
                </div>
                <div class="card-footer">
                    <span class="card-id" style="font-weight:600;">#${item.id.substring(0, 8)}</span>
                    <span class="card-time">${formatDateInput(item.created)}</span>
                </div>
            `;
            
            // Adicionar função de clique para abrir detalhes
            card.onclick = (e) => {
                if (!e.target.closest('.card-action-btn')) {
                    showDenunciaDetails(item.id);
                }
            };
            
            return card;
        }

        function saveDenuncia() {
            const id = document.getElementById('denunciaId').value;
            const title = document.getElementById('denunciaTitulo').value.trim();
            const player = document.getElementById('denunciaPlayer').value.trim();
            const desc = document.getElementById('denunciaDesc').value.trim();
            const topicoSelect = document.getElementById('denunciaTopicoSelect');
            const topicoId = topicoSelect.value;
            
            if (!title || !player || !topicoId) {
                showToast('Preencha Título, Player e Tópico.', 'warning');
                return;
            }
            
            const now = Date.now();
            
            if (id) {
                // Editar existente
                const itemIndex = data.denuncias.items.findIndex(d => d.id === id);
                if (itemIndex > -1) {
                    const originalItem = data.denuncias.items[itemIndex];
                    originalItem.title = title;
                    originalItem.player = player;
                    originalItem.description = desc;
                    originalItem.topicoId = topicoId;
                    originalItem.updated = now;
                    
                    // Adicionar ao histórico
                    addHistory(id, `Denúncia "${title}" atualizada`, 'denuncia', 'edit');
                    
                    showToast('Denúncia atualizada com sucesso!', 'success');
                }
            } else {
                // Nova denúncia
                const newId = generateId();
                const newDenuncia = {
                    id: newId,
                    title,
                    player,
                    description: desc,
                    topicoId,
                    assignee: null,
                    anexos: [], // Anexos serão tratados no futuro
                    created: now,
                    updated: now
                };
                data.denuncias.items.unshift(newDenuncia);
                
                // Adicionar ao histórico
                addHistory(newId, `Denúncia "${title}" registrada em ${getTopicoById(topicoId).name}`, 'denuncia', 'new');
                
                showToast('Nova denúncia registrada com sucesso!', 'success');
            }
            
            closeModal('newDenunciaModal');
            saveData();
            renderDenunciasBoard();
        }
        
        function showDenunciaDetails(id) {
            const item = data.denuncias.items.find(d => d.id === id);
            if (!item) return;
            
            const topico = getTopicoById(item.topicoId);
            const modal = document.getElementById('denunciaDetailsModal');
            
            document.getElementById('denunciaDetailsId').textContent = item.id;
            document.getElementById('denunciaDetailsTitle').textContent = `Detalhes: ${item.title}`;
            document.getElementById('denunciaDetailsPlayer').textContent = item.player;
            document.getElementById('denunciaDetailsTopico').textContent = topico.name;
            document.getElementById('denunciaDetailsTopico').style.color = topico.color;
            document.getElementById('denunciaDetailsStatus').textContent = topico.name; // Usando o tópico como status
            document.getElementById('denunciaDetailsAssignee').textContent = item.assignee || 'Não Atribuído';
            document.getElementById('denunciaDetailsDesc').textContent = item.description;
            document.getElementById('denunciaDetailsCreated').textContent = formatTime(item.created);
            document.getElementById('denunciaDetailsUpdated').textContent = formatTime(item.updated);
            
            // Anexos (Placeholder)
            document.getElementById('denunciaDetailsAnexos').innerHTML = item.anexos && item.anexos.length > 0 ? 
                item.anexos.map(anexo => `<a href="${anexo.url}" target="_blank" style="margin-right: 5px;"><i class="fas fa-file-alt"></i> ${anexo.name}</a>`).join('') :
                '<span style="color:var(--text-light);">Nenhum anexo.</span>';
                
            modal.setAttribute('data-denuncia-id', item.id);
            openModal('denunciaDetailsModal');
        }
        
        function editDenunciaDetails() {
            const id = document.getElementById('denunciaDetailsModal').getAttribute('data-denuncia-id');
            const item = data.denuncias.items.find(d => d.id === id);
            if (!item) return;

            // Preenche o modal de nova denúncia com os dados do item
            document.getElementById('denunciaId').value = item.id;
            document.getElementById('denunciaTitulo').value = item.title;
            document.getElementById('denunciaPlayer').value = item.player;
            document.getElementById('denunciaDesc').value = item.description;
            document.getElementById('denunciaAnexosPreview').innerHTML = ''; // Anexos não são editáveis na modal simples
            document.getElementById('saveDenunciaBtn').textContent = 'Salvar Alterações';
            
            // Seleciona o tópico correto
            const topicoSelect = document.getElementById('denunciaTopicoSelect');
            topicoSelect.value = item.topicoId;

            closeModal('denunciaDetailsModal');
            openModal('newDenunciaModal');
        }

        function deleteDenuncia(id = null) {
            const itemId = id || document.getElementById('denunciaDetailsModal').getAttribute('data-denuncia-id');
            if (!itemId) return;

            if (confirm('Tem certeza que deseja excluir esta denúncia? Esta ação é irreversível.')) {
                const itemIndex = data.denuncias.items.findIndex(d => d.id === itemId);
                if (itemIndex > -1) {
                    const deletedItem = data.denuncias.items.splice(itemIndex, 1)[0];
                    
                    addHistory(itemId, `Denúncia "${deletedItem.title}" excluída`, 'denuncia', 'delete');
                    
                    showToast('Denúncia excluída com sucesso!', 'success');
                    closeModal('denunciaDetailsModal');
                    saveData();
                    renderDenunciasBoard();
                }
            }
        }
        
        // Funções Drag and Drop
        function allowDrop(ev) {
            ev.preventDefault();
        }

        function drag(ev, id) {
            ev.dataTransfer.setData("text", id);
        }

        function drop(ev) {
            ev.preventDefault();
            const id = ev.dataTransfer.getData("text");
            const targetColumn = ev.currentTarget.closest('.board-column');
            
            if (targetColumn) {
                const newTopicoId = targetColumn.getAttribute('data-topico-id');
                const item = data.denuncias.items.find(d => d.id === id);
                
                if (item && item.topicoId !== newTopicoId) {
                    const oldTopicoId = item.topicoId;
                    item.topicoId = newTopicoId;
                    item.updated = Date.now();
                    
                    // Se estiver sendo movido para "Em Andamento" (atribuida), atribui ao usuário atual se não estiver atribuído
                    if (newTopicoId === 'atribuida' && !item.assignee) {
                        item.assignee = currentUser;
                    }
                    
                    addHistory(id, `Denúncia "${item.title}" movida de ${getTopicoById(oldTopicoId).name} para ${getTopicoById(newTopicoId).name}`, 'denuncia', 'move');
                    
                    showToast(`Denúncia movida para ${getTopicoById(newTopicoId).name}`, 'info');
                    saveData();
                    renderDenunciasBoard();
                }
            }
        }
        
        function openMoveModal(id) {
            currentDenunciaIdToMove = id;
            const select = document.getElementById('moveTopicoSelect');
            select.innerHTML = '';
            
            const currentItem = data.denuncias.items.find(d => d.id === id);

            data.denuncias.topicos.forEach(topico => {
                const option = document.createElement('option');
                option.value = topico.id;
                option.textContent = topico.name;
                select.appendChild(option);
            });
            
            if (currentItem) select.value = currentItem.topicoId;
            
            initCustomSelect();
            openModal('moveDenunciaModal');
        }
        
        function confirmMoveDenuncia() {
            const id = currentDenunciaIdToMove;
            const newTopicoId = document.getElementById('moveTopicoSelect').value;
            
            if (!id || !newTopicoId) return;
            
            const item = data.denuncias.items.find(d => d.id === id);
            
            if (item && item.topicoId !== newTopicoId) {
                const oldTopicoId = item.topicoId;
                item.topicoId = newTopicoId;
                item.updated = Date.now();
                
                // Atribui ao usuário se movido para 'Em Andamento' e não tiver atribuição
                if (newTopicoId === 'atribuida' && !item.assignee) {
                    item.assignee = currentUser;
                }
                
                addHistory(id, `Denúncia "${item.title}" movida (modal) de ${getTopicoById(oldTopicoId).name} para ${getTopicoById(newTopicoId).name}`, 'denuncia', 'move');
                
                showToast(`Denúncia movida para ${getTopicoById(newTopicoId).name}`, 'info');
                saveData();
                renderDenunciasBoard();
            }
            
            closeModal('moveDenunciaModal');
        }

        function renderTopicosList() {
            const list = document.getElementById('topicosList');
            list.innerHTML = '';
            
            data.denuncias.topicos.forEach(topico => {
                const li = document.createElement('li');
                li.style.display = 'flex';
                li.style.justifyContent = 'space-between';
                li.style.alignItems = 'center';
                li.style.padding = '8px 0';
                li.style.borderBottom = '1px solid var(--border)';
                
                li.innerHTML = `
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span style="display:inline-block; width:15px; height:15px; border-radius:3px; background-color:${topico.color};"></span>
                        <span style="font-weight: 500;">${topico.name}</span>
                    </div>
                    <button class="btn btn-sm" style="background-color: var(--danger);" onclick="removeTopico('${topico.id}')"><i class="fas fa-trash"></i></button>
                `;
                list.appendChild(li);
            });
        }
        
        function addTopico() {
            const nameInput = document.getElementById('newTopicoName');
            const colorInput = document.getElementById('newTopicoColor');
            const name = nameInput.value.trim();
            const color = colorInput.value;
            
            if (!name) {
                showToast('O nome do tópico é obrigatório.', 'warning');
                return;
            }
            
            // Criar ID baseado no nome
            const id = name.toLowerCase().replace(/\s/g, '-');
            
            if (data.denuncias.topicos.find(t => t.id === id)) {
                showToast('Um tópico com este nome já existe.', 'error');
                return;
            }
            
            data.denuncias.topicos.push({ id, name, color });
            renderTopicosList();
            renderDenunciasBoard();
            saveData();
            nameInput.value = '';
            showToast(`Tópico "${name}" adicionado.`, 'success');
        }
        
        function removeTopico(id) {
            if (data.denuncias.topicos.length <= 1) {
                showToast('É necessário pelo menos um tópico.', 'error');
                return;
            }
            
            if (confirm('Tem certeza que deseja remover este tópico? As denúncias neste tópico serão movidas para o primeiro tópico restante.')) {
                const index = data.denuncias.topicos.findIndex(t => t.id === id);
                if (index > -1) {
                    const removedTopico = data.denuncias.topicos.splice(index, 1)[0];
                    const newDefaultTopicoId = data.denuncias.topicos[0].id;
                    
                    // Mover denúncias do tópico removido para o novo padrão
                    data.denuncias.items.forEach(item => {
                        if (item.topicoId === id) {
                            item.topicoId = newDefaultTopicoId;
                        }
                    });

                    renderTopicosList();
                    renderDenunciasBoard();
                    saveData();
                    showToast(`Tópico "${removedTopico.name}" removido e denúncias movidas.`, 'success');
                }
            }
        }
        
        function populateTopicoSelect(selectElement) {
            selectElement.innerHTML = '';
            data.denuncias.topicos.forEach(topico => {
                const option = document.createElement('option');
                option.value = topico.id;
                option.textContent = topico.name;
                selectElement.appendChild(option);
            });
        }

        function saveDenunciasBg() {
            const url = document.getElementById('denunciasBgUrl').value.trim();
            data.denuncias.bgUrl = url;
            document.getElementById('denuncias').style.backgroundImage = url ? `url(${url})` : 'var(--denuncias-bg)';
            saveData();
            showToast('Fundo do Quadro de Denúncias atualizado.', 'success');
        }

        function clearDenunciasBg() {
            data.denuncias.bgUrl = '';
            document.getElementById('denunciasBgUrl').value = '';
            document.getElementById('denuncias').style.backgroundImage = 'var(--denuncias-bg)';
            saveData();
            showToast('Fundo do Quadro de Denúncias removido.', 'success');
        }


        // =========================
        // Funções de Fichas (Registro de Players)
        // =========================

        function renderFichasGrid() {
            const grid = document.getElementById('fichasGrid');
            grid.innerHTML = '';
            
            if (data.fichas.length === 0) {
                grid.innerHTML = '<p style="color:var(--text-light);">Nenhuma ficha registrada.</p>';
                return;
            }

            data.fichas.forEach(ficha => {
                const card = document.createElement('div');
                card.classList.add('player-card');
                card.setAttribute('onclick', `showFichaDetails('${ficha.id}')`);

                card.innerHTML = `
                    <div class="player-actions">
                        <button class="card-action-btn" onclick="event.stopPropagation(); deleteFicha('${ficha.id}')" title="Excluir"><i class="fas fa-trash"></i></button>
                    </div>
                    <span class="player-id">ID: ${ficha.playerId}</span>
                    <h4 class="player-name">${ficha.playerName}</h4>
                    <p class="player-behavior">${ficha.behavior.substring(0, 80)}...</p>
                    <div class="player-stats">
                        <div class="stat-badge">
                            <div class="stat-badge-value">${ficha.advertencias}</div>
                            <div class="stat-badge-label">Advertências</div>
                        </div>
                        <div class="stat-badge">
                            <div class="stat-badge-value" style="color:var(--danger);">${ficha.bans}</div>
                            <div class="stat-badge-label">Bans</div>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
            renderDashboardStats();
        }

        function filterFichas() {
            const search = document.getElementById('fichaSearch').value.toLowerCase();
            const cards = document.querySelectorAll('.player-card');
            
            cards.forEach(card => {
                const name = card.querySelector('.player-name').textContent.toLowerCase();
                const id = card.querySelector('.player-id').textContent.toLowerCase();
                
                if (name.includes(search) || id.includes(search)) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        function saveFicha() {
            const id = document.getElementById('fichaId').value;
            const playerName = document.getElementById('fichaPlayerName').value.trim();
            const playerId = document.getElementById('fichaPlayerId').value.trim();
            const behavior = document.getElementById('fichaBehavior').value.trim();
            const advertencias = parseInt(document.getElementById('fichaAdvertencias').value) || 0;
            const bans = parseInt(document.getElementById('fichaBans').value) || 0;

            if (!playerName || !playerId) {
                showToast('Nome e ID do Player são obrigatórios.', 'warning');
                return;
            }

            const now = Date.now();
            
            if (id) {
                // Editar existente
                const itemIndex = data.fichas.findIndex(f => f.id === id);
                if (itemIndex > -1) {
                    const originalFicha = data.fichas[itemIndex];
                    originalFicha.playerName = playerName;
                    originalFicha.playerId = playerId;
                    originalFicha.behavior = behavior;
                    originalFicha.advertencias = advertencias;
                    originalFicha.bans = bans;
                    originalFicha.updated = now;

                    addHistory(id, `Ficha de Player "${playerName}" atualizada`, 'ficha', 'edit');

                    showToast('Ficha de Player atualizada com sucesso!', 'success');
                }
            } else {
                // Nova ficha
                const newId = generateId();
                const newFicha = {
                    id: newId,
                    playerName,
                    playerId,
                    behavior,
                    advertencias,
                    bans,
                    created: now,
                    updated: now
                };
                data.fichas.unshift(newFicha);

                addHistory(newId, `Ficha de Player "${playerName}" registrada`, 'ficha', 'new');
                
                showToast('Nova Ficha de Player registrada com sucesso!', 'success');
            }

            closeModal('newFichaModal');
            saveData();
            renderFichasGrid();
        }

        function showFichaDetails(id) {
            const ficha = data.fichas.find(f => f.id === id);
            if (!ficha) return;
            
            const modal = document.getElementById('fichaDetailsModal');
            
            document.getElementById('fichaDetailsName').textContent = ficha.playerName;
            document.getElementById('fichaDetailsId').textContent = `Discord ID: ${ficha.playerId}`;
            document.getElementById('fichaDetailsPlayerName').textContent = ficha.playerName;
            document.getElementById('fichaDetailsBehavior').textContent = ficha.behavior || 'Nenhuma anotação de comportamento.';
            document.getElementById('fichaDetailsAdvertencias').textContent = ficha.advertencias;
            document.getElementById('fichaDetailsBans').textContent = ficha.bans;
            
            modal.setAttribute('data-ficha-id', ficha.id);
            openModal('fichaDetailsModal');
        }

        function editFichaDetails() {
            const id = document.getElementById('fichaDetailsModal').getAttribute('data-ficha-id');
            const ficha = data.fichas.find(f => f.id === id);
            if (!ficha) return;

            document.getElementById('fichaId').value = ficha.id;
            document.getElementById('fichaPlayerName').value = ficha.playerName;
            document.getElementById('fichaPlayerId').value = ficha.playerId;
            document.getElementById('fichaBehavior').value = ficha.behavior;
            document.getElementById('fichaAdvertencias').value = ficha.advertencias;
            document.getElementById('fichaBans').value = ficha.bans;
            document.getElementById('saveFichaBtn').textContent = 'Salvar Alterações';
            document.getElementById('fichaModalTitle').textContent = 'Editar Ficha';

            closeModal('fichaDetailsModal');
            openModal('newFichaModal');
        }

        function deleteFicha(id = null) {
            const fichaId = id || document.getElementById('fichaDetailsModal').getAttribute('data-ficha-id');
            if (!fichaId) return;

            if (confirm('Tem certeza que deseja excluir esta ficha?')) {
                const itemIndex = data.fichas.findIndex(f => f.id === fichaId);
                if (itemIndex > -1) {
                    const deletedFicha = data.fichas.splice(itemIndex, 1)[0];
                    
                    addHistory(fichaId, `Ficha de Player "${deletedFicha.playerName}" excluída`, 'ficha', 'delete');
                    
                    showToast('Ficha de Player excluída com sucesso!', 'success');
                    closeModal('fichaDetailsModal');
                    saveData();
                    renderFichasGrid();
                }
            }
        }


        // =========================
        // Funções da Agenda
        // =========================

        function initCalendar() {
            const monthYearDisplay = document.getElementById('currentMonthYear');
            monthYearDisplay.textContent = new Date(currentYear, currentMonth).toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
            renderCalendarDays();
        }

        function changeMonth(delta) {
            currentMonth += delta;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            } else if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            initCalendar();
        }

        function renderCalendarDays() {
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';

            const dayNames = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
            dayNames.forEach(name => {
                const dayName = document.createElement('div');
                dayName.classList.add('calendar-day-name');
                dayName.textContent = name;
                grid.appendChild(dayName);
            });

            const firstDayOfMonth = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const today = new Date();
            const todayDateString = today.toISOString().split('T')[0];

            // Dias do mês anterior
            const daysInPrevMonth = new Date(currentYear, currentMonth, 0).getDate();
            for (let i = firstDayOfMonth - 1; i >= 0; i--) {
                const day = document.createElement('div');
                day.classList.add('calendar-day', 'other-month');
                day.innerHTML = `<div class="day-number">${daysInPrevMonth - i}</div>`;
                grid.appendChild(day);
            }

            // Dias do mês atual
            for (let dayNum = 1; dayNum <= daysInMonth; dayNum++) {
                const date = new Date(currentYear, currentMonth, dayNum);
                const dateString = date.toISOString().split('T')[0];

                const day = document.createElement('div');
                day.classList.add('calendar-day');
                day.setAttribute('data-date', dateString);
                day.setAttribute('onclick', `openAppointmentModal('${dateString}')`);

                if (dateString === todayDateString) {
                    day.classList.add('today');
                }

                day.innerHTML = `<div class="day-number">${dayNum}</div><div class="appointments-list"></div>`;

                // Renderizar compromissos
                const appointmentsList = day.querySelector('.appointments-list');
                const appointmentsOnDay = data.agenda.filter(app => {
                    const appDate = app.date.split('T')[0]; // Ignora a hora para comparação de data
                    return appDate === dateString;
                });

                appointmentsOnDay.forEach(app => {
                    const time = app.time ? app.time.substring(0, 5) : '';
                    const appointmentItem = document.createElement('div');
                    appointmentItem.classList.add('appointment-item');
                    appointmentItem.innerHTML = `
                        <span>${time} ${app.title}</span>
                        <div class="appointment-actions">
                            <button onclick="event.stopPropagation(); editAppointment('${app.id}')" title="Editar"><i class="fas fa-edit"></i></button>
                            <button onclick="event.stopPropagation(); deleteAppointment('${app.id}')" title="Excluir"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    appointmentsList.appendChild(appointmentItem);
                });


                grid.appendChild(day);
            }
        }
        
        function openAppointmentModal(dateString = null) {
            openModal('newAppointmentModal');
            if (dateString) {
                document.getElementById('appointmentDate').value = dateString;
            }
        }
        
        function saveAppointment() {
            const id = document.getElementById('appointmentId').value;
            const title = document.getElementById('appointmentTitle').value.trim();
            const date = document.getElementById('appointmentDate').value;
            const time = document.getElementById('appointmentTime').value.trim();
            const desc = document.getElementById('appointmentDesc').value.trim();
            
            if (!title || !date) {
                showToast('Título e Data são obrigatórios.', 'warning');
                return;
            }
            
            const now = Date.now();
            const appointmentDate = new Date(`${date}T${time || '00:00'}:00`);
            
            if (id) {
                // Editar
                const itemIndex = data.agenda.findIndex(a => a.id === id);
                if (itemIndex > -1) {
                    const originalApp = data.agenda[itemIndex];
                    originalApp.title = title;
                    originalApp.date = date;
                    originalApp.time = time;
                    originalApp.description = desc;
                    originalApp.timestamp = appointmentDate.getTime();
                    originalApp.updated = now;
                    
                    addHistory(id, `Evento "${title}" atualizado`, 'agenda', 'edit');
                    
                    showToast('Evento atualizado com sucesso!', 'success');
                }
            } else {
                // Novo
                const newId = generateId();
                const newAppointment = {
                    id: newId,
                    title,
                    date,
                    time,
                    description: desc,
                    timestamp: appointmentDate.getTime(),
                    created: now
                };
                data.agenda.push(newAppointment);
                
                addHistory(newId, `Evento "${title}" agendado para ${date}`, 'agenda', 'new');
                
                showToast('Novo evento agendado com sucesso!', 'success');
            }
            
            closeModal('newAppointmentModal');
            saveData();
            initCalendar();
            renderUpcomingAppointments();
        }

        function editAppointment(id) {
            const appointment = data.agenda.find(a => a.id === id);
            if (!appointment) return;
            
            document.getElementById('appointmentId').value = appointment.id;
            document.getElementById('appointmentTitle').value = appointment.title;
            document.getElementById('appointmentDate').value = appointment.date;
            document.getElementById('appointmentTime').value = appointment.time;
            document.getElementById('appointmentDesc').value = appointment.description;
            document.getElementById('appointmentModalTitle').textContent = 'Editar Evento';
            document.getElementById('saveAppointmentBtn').textContent = 'Salvar Alterações';
            
            openModal('newAppointmentModal');
        }

        function deleteAppointment(id) {
            if (confirm('Tem certeza que deseja excluir este evento?')) {
                const itemIndex = data.agenda.findIndex(a => a.id === id);
                if (itemIndex > -1) {
                    const deletedApp = data.agenda.splice(itemIndex, 1)[0];
                    
                    addHistory(id, `Evento "${deletedApp.title}" excluído`, 'agenda', 'delete');
                    
                    showToast('Evento excluído com sucesso!', 'success');
                    saveData();
                    initCalendar();
                    renderUpcomingAppointments();
                }
            }
        }
        
        function renderUpcomingAppointments() {
            const list = document.getElementById('upcomingAppointmentsList');
            const now = Date.now();
            
            const upcoming = data.agenda
                .filter(app => app.timestamp >= now)
                .sort((a, b) => a.timestamp - b.timestamp)
                .slice(0, 5); // Mostrar os próximos 5

            if (upcoming.length === 0) {
                list.innerHTML = '<p style="color:var(--text-light);">Nenhum compromisso agendado.</p>';
                return;
            }

            list.innerHTML = '';
            upcoming.forEach(app => {
                const item = document.createElement('div');
                item.classList.add('upcoming-appointment-item');
                
                const dateDisplay = new Date(app.timestamp).toLocaleDateString('pt-BR', { day: '2-digit', month: 'short' });
                const timeDisplay = app.time ? app.time.substring(0, 5) : 'Dia Inteiro';

                item.innerHTML = `
                    <span class="appointment-date">${dateDisplay} ${timeDisplay}</span>
                    <span class="appointment-title">${app.title}</span>
                `;
                list.appendChild(item);
            });
        }


        // =========================
        // Funções de Histórico
        // =========================

        function addHistory(itemId, description, type, action) {
            const historyItem = {
                id: generateId(),
                itemId,
                description,
                type,
                action,
                user: currentUser,
                timestamp: Date.now()
            };
            data.historico.unshift(historyItem); // Adiciona no início para ser mais recente
            
            // Limitar o histórico total para evitar inchaço
            if (data.historico.length > 500) {
                data.historico.pop();
            }
            
            saveData();
            // Atualizar o histórico do dashboard, se visível
            if (document.getElementById('dashboard').classList.contains('active')) {
                renderDashboardHistory();
            }
        }
        
        function getActionIcon(action) {
            switch(action) {
                case 'new': return 'fa-plus-circle';
                case 'edit': return 'fa-edit';
                case 'delete': return 'fa-trash';
                case 'move': return 'fa-arrows-alt';
                default: return 'fa-info-circle';
            }
        }

        function renderDashboardHistory() {
            const list = document.getElementById('dashboardHistory');
            list.innerHTML = '';
            
            if (data.historico.length === 0) {
                list.innerHTML = '<p style="color:var(--text-light);">Nenhuma ação recente.</p>';
                return;
            }

            // Mostrar os 5 mais recentes
            const recentHistory = data.historico.slice(0, 5);

            recentHistory.forEach(item => {
                const li = document.createElement('div');
                li.classList.add('history-item');
                
                li.innerHTML = `
                    <i class="fas ${getActionIcon(item.action)} history-icon" style="color:var(--primary);"></i>
                    <div class="history-content">
                        <div class="history-title">${item.description}</div>
                        <div class="history-time">${formatTime(item.timestamp)} por ${item.user}</div>
                    </div>
                `;
                list.appendChild(li);
            });
        }

        function initFullHistorico() {
            const list = document.getElementById('fullHistoricoList');
            list.innerHTML = '';

            if (data.historico.length === 0) {
                list.innerHTML = '<p style="color:var(--text-light);">Nenhum histórico registrado.</p>';
                return;
            }
            
            data.historico.forEach(item => {
                const li = document.createElement('div');
                li.classList.add('history-item');
                li.style.cursor = 'default';
                
                li.innerHTML = `
                    <i class="fas ${getActionIcon(item.action)} history-icon" style="color:var(--primary);"></i>
                    <div class="history-content">
                        <div class="history-title">${item.description}</div>
                        <div class="history-time">${formatTime(item.timestamp)} por ${item.user}</div>
                    </div>
                `;
                list.appendChild(li);
            });
        }


        // =========================
        // Funções de Dashboard (Estatísticas)
        // =========================
        
        function renderDashboardStats() {
            const totalDenuncias = data.denuncias.items.length;
            const denunciasNaoAtribuidas = data.denuncias.items.filter(d => !d.assignee).length;
            const seusCasosAbertos = data.denuncias.items.filter(d => d.assignee === currentUser && d.topicoId !== 'concluida' && d.topicoId !== 'arquivada').length;
            const fichasRegistradas = data.fichas.length;
            
            document.getElementById('totalDenuncias').textContent = totalDenuncias;
            document.getElementById('denunciasNaoAtribuidas').textContent = denunciasNaoAtribuidas;
            document.getElementById('seusCasosAbertos').textContent = seusCasosAbertos;
            document.getElementById('fichasRegistradas').textContent = fichasRegistradas;
            
            // Carregar anotações rápidas no dashboard
            document.getElementById('anotacoesRapidas').value = data.anotacoes.rapidas[currentUser] || '';
        }

        // =========================
        // Funções de Export/Import
        // =========================
        
        function exportData() {
            const dataStr = JSON.stringify(data, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `staff_portal_backup_${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showToast('Dados exportados com sucesso!', 'success');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    // Validação simples para garantir que é um arquivo de backup
                    if (importedData.denuncias && importedData.fichas && importedData.agenda) {
                        data = importedData;
                        // Forçar a reescrita no localStorage
                        localStorage.setItem('appData', JSON.stringify(data));
                        // Recarregar tudo
                        initApp();
                        // Trocar para dashboard após importação
                        changeTab('dashboard');
                        showToast('Dados importados com sucesso! Necessário relogin.', 'success');
                        
                        // Forçar relogin para recarregar com novo contexto
                        handleLogout(); 
                    } else {
                        throw new Error("Estrutura de dados inválida.");
                    }
                } catch (error) {
                    showToast('Erro ao importar arquivo. Verifique se é um JSON de backup válido.', 'error');
                    console.error('Erro de importação:', error);
                }
            };
            reader.readAsText(file);
        }

        // =========================
        // Funções para Seletor Personalizado (Custom Select)
        // =========================

        function initCustomSelect() {
            var x, i, j, l, ll, selElmnt, a, b, c;
            /*look for any elements with the class "custom-select-container":*/
            x = document.getElementsByClassName("custom-select-container");
            l = x.length;
            for (i = 0; i < l; i++) {
              selElmnt = x[i].getElementsByTagName("select")[0];
              ll = selElmnt.length;
              /*for each element, create a new DIV that will act as the selected item:*/
              a = document.createElement("DIV");
              a.setAttribute("class", "select-selected");
              a.innerHTML = selElmnt.options[selElmnt.selectedIndex].innerHTML;
              x[i].appendChild(a);
              /*for each element, create a new DIV that will contain the option list:*/
              b = document.createElement("DIV");
              b.setAttribute("class", "select-items select-hide");
              for (j = 0; j < ll; j++) {
                /*for each option in the original select element,
                create a new DIV that will act as an option item:*/
                c = document.createElement("DIV");
                c.innerHTML = selElmnt.options[j].innerHTML;
                c.addEventListener("click", function(e) {
                    /*when an item is clicked, update the original select box,
                    and the selected item:*/
                    var y, i, k, s, h, sl, yl;
                    s = this.parentNode.parentNode.getElementsByTagName("select")[0];
                    sl = s.length;
                    h = this.parentNode.previousSibling;
                    for (i = 0; i < sl; i++) {
                      if (s.options[i].innerHTML == this.innerHTML) {
                        s.selectedIndex = i;
                        h.innerHTML = this.innerHTML;
                        y = this.parentNode.getElementsByClassName("same-as-selected");
                        yl = y.length;
                        for (k = 0; k < yl; k++) {
                          y[k].removeAttribute("class");
                        }
                        this.setAttribute("class", "same-as-selected");
                        break;
                      }
                    }
                    h.click();
                    // Dispara evento 'change' no select original para que a lógica de negócio seja acionada
                    s.dispatchEvent(new Event('change'));

                    // Lógica específica para o seletor de tema
                    if (s.id === 'themeSelector') {
                        const selectedTheme = s.value;
                        if (selectedTheme === 'custom') {
                            customThemeContainer.style.display = 'block';
                            applyCustomTheme();
                        } else {
                            customThemeContainer.style.display = 'none';
                            applyTheme(selectedTheme);
                        }
                    }
                });
                b.appendChild(c);
              }
              x[i].appendChild(b);
              a.addEventListener("click", function(e) {
                  /*when the select box is clicked, close any other select boxes,
                  and open/close the current select box:*/
                  e.stopPropagation();
                  closeAllSelect(this);
                  this.nextSibling.classList.toggle("select-hide");
                  this.classList.toggle("select-arrow-active");
                });
            }

            function closeAllSelect(elmnt) {
              /*a function that will close all select boxes in the document,
              except the current select box:*/
              var x, y, i, xl, yl, arrNo = [];
              x = document.getElementsByClassName("select-items");
              y = document.getElementsByClassName("select-selected");
              xl = x.length;
              yl = y.length;
              for (i = 0; i < yl; i++) {
                if (elmnt == y[i]) {
                  arrNo.push(i)
                } else {
                  y[i].classList.remove("select-arrow-active");
                }
              }
              for (i = 0; i < xl; i++) {
                if (arrNo.indexOf(i)) {
                  x[i].classList.add("select-hide");
                }
              }
            }
            /*if the user clicks anywhere outside the select box,
            then close all select boxes:*/
            document.addEventListener("click", closeAllSelect);
        }
        // FIM: FUNÇÃO PARA SELETOR PERSONALIZADO

        // =========================
        // Inicialização
        // =========================
        
        // Chamar a função principal ao carregar a página
        checkAuth();
        
    </script>

    <div class="modal" id="moveDenunciaModal">
      <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
          <h3 class="modal-title">Mover Denúncia</h3>
          <button class="modal-close" onclick="document.getElementById('moveDenunciaModal').style.display='none'">&times;</button>
        </div>
        <div class="modal-body">
          <p>Selecione o novo tópico:</p>
          <div class="custom-select-container">
            <select id="moveTopicoSelect"></select>
          </div>
          </div>
        <div class="modal-footer">
            <button class="btn" onclick="confirmMoveDenuncia()" id="confirmMoveBtn">Mover</button>
        </div>
      </div>
    </div>
</body>
</html>